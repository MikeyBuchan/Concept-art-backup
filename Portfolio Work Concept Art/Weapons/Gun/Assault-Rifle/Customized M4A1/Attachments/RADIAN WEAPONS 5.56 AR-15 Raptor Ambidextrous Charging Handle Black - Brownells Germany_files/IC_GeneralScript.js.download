
// Jump to correct tab with hash attached
jq(document).ready(function () {
  jq(".ui-tabs").each( function(i) {
    var hash = jq.trim( window.location.hash );
    if( hash && jq(this).find('a[href$="'+hash+'"]').length > 0) {
      jq(this).find('.ui-tabs-active').each( function(i) {
        jq(this).removeClass("ui-tabs-active ui-state-active");
      });

      var target = jq(this).find('a[href$="'+hash+'"]');
      target.parent().addClass("ui-tabs-active ui-state-active");
    }
  });

  jq(".ui-tabs").on( "tabscreate", function( event, ui ) {
    var hash = jq.trim( window.location.hash );
    try {
      jq(hash).css('display','block');
      var target = jq(this).find('a[href$="'+hash+'"]');
      if( target.length > 0 ) {
        jq.scrollTo(target, { duration: 500, axis:'y', offset:-70 });
        jq( window ).bind( "scroll.ic_correction", function(event) {
          jq.scrollTo(target, { duration: 0, axis:'y', offset:-70 });
          jq( window ).unbind("scroll.ic_correction");
        });
      }
    }
    catch(e) {};
  });

  // Confirm to leave side (learning section)
  jq(".IC_LearnTab a").click( function(e) {
    e.preventDefault();
    var r = confirm(jq(this).attr('title'));
    if (r == true) {
      window.open(jq(this).attr('href'), '_blank');
    }
    return;
  });

  // T#118170 open Newsletter form on timer after certain number of page moves
  var PageCount = 3; // number of navigation steps (links clicked) on the page
  var PageTime = 7000; // time until the popup in ms
  window['NLSent'] = readCookie("NewsletterSentOn");
  window['NLNow'] = jq.now();
  var NLActive = jq('.ic-popupLinkNewsletter').length;
  if(NLActive && jq(".logout-action").length < 1 && window['NLSent'] == null) {
    // page counter handling
    window['NLCount'] = readCookie("NewsletterPageCounter");
    if(window['NLCount'] == null) {
      window['NLCount'] = 0;
    }
    window['NLCount'] = parseInt(window['NLCount']) + 1;
    createCookie("NewsletterPageCounter",window['NLCount']);

    if(window['NLCount'] >= PageCount) {
      window['loop'] = window.setInterval( function() {
        var SessionID = readCookie("SessionID");
        if(SessionID != null){
          window.clearInterval(window['loop']);
        }
        var NLCookie = readCookie("NewsletterTimer");
        if( NLCookie == null){
          createCookie("NewsletterTimer",0);
        }
        else {
          NLCookie = parseInt(NLCookie);
          if(NLCookie >= PageTime) {
            jq('.ic-popupLinkNewsletter').trigger('popup-click');
            createCookie("NewsletterSentOn",jq.now(),365);
            window.clearInterval(window['loop']);
          }
          else {
            var reallyNow = jq.now();
            NLCookie = parseInt(NLCookie) + (reallyNow - window['NLNow']);
            window['NLNow'] = reallyNow;
            createCookie("NewsletterTimer",NLCookie);
          }
        }
      }, 1000);
    }
  }
  if(NLActive) {
    jq(window).on("message", function(e) {
      var data = e.originalEvent.data;
      if(data == "removeLink"){
        jq("#IC_NoThanksMessage").hide();
      }
    });
  }

  //BROE-304 no hover zoom on touch event
  // hooks into /WebRoot/StoreTypes/6.16.3/Store/lib/ep/ui/magnifier.js
  jq(window).on("IC_OnProductImageLoad_MagnifierWidget", function(e) {
    var mag = e.magnifier;
    mag.container.on("touchstart", function(e) {
      mag.noZoom = 1;
    });
  });

  //T#122516 update basket when pressing enter after changing number of items
  jq('.Basket input[name="Quantity"]').keypress(function(e) {
    if(e.which == 13) {
      e.preventDefault();
      var refreshbutton = jq('#RefreshButtonTop');
      if(!refreshbutton.hasClass('HideElement')) {
        refreshbutton.trigger('click');
      }
    }
  });

  //T#122689 redeem coupon when pressing enter after entering coupon code
  jq('.Basket input#CouponCode').keypress(function(e) {
    if(e.which == 13) {
      e.preventDefault();
      var redeemButton = jq('#RedeemCouponButton input[type="submit"]');
      if(!redeemButton.hasClass('HideElement')) {
        redeemButton.trigger('click');
      }
    }
  });

  // BROE-295 setup of ViewMore/Less buttons on initial page load
  ICSetupViewMoreButton();
  
  // T#125044 remove filter nav element if it is empty
  if(jq('#RemoteSearchFacets').length > 0 && jq.trim(jq('#RemoteSearchFacets').text()).length == 0) {
    jq('#RemoteSearchFacets').css('display', 'none');
  }

  // BROE-606 - Analytics Event for "Click on product rating tab" 
  jq('#ProductInfoTabs').on("tabsactivate", function( event, ui ) {
    if(ui.newPanel.selector == '#tab-product-ratings') {
      ga('send', 'event', {eventCategory: 'Interaction', eventAction: 'RatingsShown_Tab'});
    }
  });

  // BROE-602 - Countdown banner
  jq('.countdownbanner').each(function() {
    jq(this).CountdownBanner( jq(this).data() );
  });

  // add iframe box hover menu
  jq('.ic-popupLink').on('click', function(event){
    event.preventDefault();
    var iframeLink = jq(this).attr('href');

    infoDialog = ep('<div class="NoPadding" style="overflow: hidden"></div>')
                    .html('<div><iframe frameBorder="0" src="' + iframeLink + '" width="620" height="332"></iframe></div>')
                    .uiDialog({
                      modal: true,
                      width: 620,
                      height: 420,
                    });
    infoDialog.uiDialog('open');
  });

  // add iframe box hover menu for newsletter (norway)
  jq('.ic-popupLinkNewsletter').on('click popup-click', function(event){
    event.preventDefault();
      var iframeLink  = jq(this).attr('href');
      var that        = jq(this);

    require([
      "ep/ui/dialog"
    ], function(){
      if(iframeLink.indexOf('ViewAction') > -1) {
        iframeLink = iframeLink.replace(/ViewAction=IC_ShowSubscriptionPage/, 'ViewAction=AJAX-IC_IncludeTemplate&IC_Template=INC-IC_APSIS-Newsletter-Popup');
      }
      else {
          if(iframeLink.indexOf('?') > -1) {
            iframeLink += '&'
          }
          else {
            iframeLink += '?'
          }
          iframeLink += 'ViewAction=AJAX-IC_IncludeTemplate&IC_Template=INC-IC_APSIS-Newsletter-Popup';
      }

      var linkTitle = that.attr('title');
      var dClass = "IC_TransparentDialog";

      // check / calculate width / height 
      var popImgW = 535;
      var popImgH = 570;

      var viewPortW = jq(window).width();
      var viewPortH = jq(window).height();

      if(viewPortW < popImgW || viewPortH < popImgH) {
        var rW  = popImgW / viewPortW;
        var rH  = popImgH / viewPortH;
        if(rH > 1 || rW > 1) {
          var r   = rW > rH ? rW : rH;
          popImgW = popImgW / r;
          popImgH = popImgH / r;
        }
      }

      if(typeof(window['infoDialogEmail']) == 'undefined') {
        if(!that.data('img')) {
          that = jq('.IC_SubscribeNewsletterLink .ic-popupLinkNewsletter');
        }
        var bgimg = that.data('img');
        var version = 2;
        if(bgimg) {
          bgimg = 'style="background-image:url('+bgimg+')"';
        }
        else {
          var aBg = {
              'no': '/WebRoot/StoreNO/Shops/Norge/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_NO.jpg',
              'de': '/WebRoot/StoreDE/Shops/Deutschland/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_DE.jpg',
              'da': '/WebRoot/StoreDK/Shops/Danmark/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_DK.jpg',
              'it': '/WebRoot/StoreIT/Shops/Italia/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_IT.jpg',
              'fi': '/WebRoot/StoreFI/Shops/Suomi/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_FI.jpg',
              'pl': '/WebRoot/StorePL/Shops/Polska/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_PL.jpg',
              'sk': '/WebRoot/StoreSK/Shops/Slovensko/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_SK.jpg',
              'sv': '/WebRoot/StoreSE/Shops/Sverige/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_SE.jpg',
              'es': '/WebRoot/StoreES/Shops/Iberica/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_ES.jpg',
              'ru': '/WebRoot/StoreRU/Shops/Russia/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_RU.jpg',
              'fr': '/WebRoot/StoreFR/Shops/France/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_FR.jpg',
              'cs': '/WebRoot/StoreCZ/Shops/Cesko/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_CZ.jpg',
              'en': '/WebRoot/StoreUK/Shops/UK/MediaGallery/NewsletterSubscription/NewsletterSubscription_BG_UK.jpg'
          }
          bgimg = 'style="background-image:url('+aBg[epages.vars.Locale.language]+')"';
          version = 1;
        }

        iframeLink  = iframeLink.indexOf('?') > -1 ? iframeLink + '&version=' + version : iframeLink + '?version=' + version;

        var nothanks = that.data('ic_apsis_text_actiondontregister');
        window['infoDialogEmail'] = ep('<div class="NoPadding" style="overflow: hidden"></div>')
                      .html('<div class="IC_NewsletterBackground" '+bgimg+'><iframe id="IC_Newsletter_Frame" name="IC_Newsletter_Frame" frameBorder="0" src="' + iframeLink + '" width="'+popImgW+'" height="'+popImgH+'" scrolling="no" allowTransparency="true"></iframe></div>')
                      .uiDialog({
                        modal: true,
                        width: popImgW,
                        height: popImgH,
                        dialogClass: dClass,
                        position: {my:"top+80", at:"top", of:(window), collision:"none"},
                        open: function() {
                          var thisJQ = jq(this);
                          //T#118170 display no thanks link under dialog
                          if(version==1) {
                            nothanks = jq('#IC_NoThanksMessageHidden').val();
                          }
                          if(nothanks == undefined){
                            nothanks = "No thanks, I already subscribe to your newsletter";
                          }
                          var msgDiv = jq('#IC_NoThanksMessage');
                          if(!msgDiv.length) {
                            msgDiv = jq('<div id="IC_NoThanksMessage"><a href="javascript:void(0);">'+nothanks+'</a></div>');
                          }
                          thisJQ.after(msgDiv);
                          msgDiv.children("a").click(function(e){
                            e.preventDefault();
                            window['infoDialogEmail'].uiDialog('close');
                          });
                          jq('.ui-widget-overlay').addClass('ic-newsletter-overlay');
                          var htmlJQ = jq('html')
                          if(htmlJQ.hasClass('ie8') || htmlJQ.hasClass('ie9')) {
                            jq('.ui-dialog-titlebar-close').addClass('ic-newsletter-closebtn-ie');
                          }
                          else {
                            jq('.ui-dialog-titlebar-close').addClass('ic-newsletter-closebtn');
                          }
                          jq('.IC_NewsletterBackground').toggleClass("Cover", (jq('.IC_NewsletterBackground').width() / jq('.IC_NewsletterBackground').height() > popImgW / popImgH));
                        },
                        close: function() {
                          jq('.ui-widget-overlay').removeClass('ic-newsletter-overlay');
                          jq('.ui-dialog-titlebar-close').removeClass('ic-newsletter-closebtn');
                          jq('.ui-dialog-titlebar-close').removeClass('ic-newsletter-closebtn-ie');
                        },
                      });
        jq(window).on('resize', function(){
          var bgW  = jq('.IC_NewsletterBackground').width();
          jq('#IC_Newsletter_Frame').css('width', bgW);
          jq('#IC_Newsletter_Frame').css('height', bgW * popImgH / popImgW);
          window['infoDialogEmail'].uiDialog('option', "position", window['infoDialogEmail'].uiDialog('option', "position"));
        });
      }
      else {
        var event = document.createEvent('CustomEvent');
        event.initCustomEvent('popupshow', true, true, null);
        frames['IC_Newsletter_Frame'].document.dispatchEvent(event);
        jq("#IC_NoThanksMessage").show();
      }
      window['infoDialogEmail'].uiDialog('open');
    });
  });

  // correct size of crossselling box
  if(jq('.product-page').length > 0 && jq('#ProductCrossTabs').length > 0) {
    if (jq('.InfoArea').height() <= (jq('.ProductImage').height()+jq('#ProductInfoTabs').height()+400)) {
      jq('#ProductCrossTabs').addClass('CrossSellingWide');
    } else {
      jq('#ProductCrossTabs').addClass('CrossSellingNarrow');
    }
  }

  // Add h3 click behaviour in product list
  IC_InitProductListEvents();

  // Add Mac detection
  if(navigator.platform.match('Mac') !== null) {
    jq('html').addClass('mac');
  }

});

// Go with adding AddThis
(function(i,s,o,g,r,a,m){i['AddThis']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();
})(window,document,'script','//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53fdd2f11653fadd', 'ad');
  
function innoLoadAddThis() {
  var s = document;
  var g = '//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53fdd2f11653fadd';
  
  var a=s.createElement('script');
  var m=s.getElementsByTagName('script')[0];
  a.async=1;
  a.src=g;
  m.parentNode.insertBefore(a,m);
}
  
jq(document).ready(function () {
  if(typeof IC_isPolicyApproved === 'function' && IC_isPolicyApproved('AddThis') && typeof innoLoadAddThis === 'function'){
    innoLoadAddThis();
  }
});

function isMobileMode() {
  return jq("link[href*='IC_GeneralStyleMobile.css']").length > 0 ? true : false;
}

function isDesktopMode() {
  return jq("link[href*='IC_GeneralStyle.css']").length > 0 ? true : false;
}

// read cookie
function readCookie(name, localonly) {
  var nameEQ = escape(name) + "=";
  var ca = document.cookie.split(';');
  var result = undefined;
  for (var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return unescape(c.substring(nameEQ.length, c.length));
  }

  // check if cookie can be found in the config cookies area
  if(typeof(epcookies) != 'undefined' && name in epcookies && !localonly) {
    return epcookies[name];
  }

  return result;
}

// write cookie
function createCookie(name,value,days,httponly) {
  if (days) {
    var date = new Date();
    date.setTime(date.getTime()+(days*24*60*60*1000));
    var expires = "; expires="+date.toGMTString();
    if(days > 7 || httponly) {
      var data = {'ChangeAction' : 'JSONSetCookie',
                  'ViewAction' : 'JSONGetCookie',
                  'Name' : name,
                  'Value' : value,
                  'ExpiresDays' : days,
                  'Comment' : ''};

      url = '/';
      jq.ajax({
        url: url,
        async : true,
        method: 'POST',
        data : data,
        dataType : 'json'
      }).done(function(data) {
        result = data.Value;
      });
    }
  }
  else var expires = "";
  document.cookie = name+"="+value+expires+"; path=/";

  if( typeof(epcookies) != 'undefined' ) {
    epcookies[name] = value;
    if(days <=0) {
      delete epcookies[name]
    }
  }
}

//delete cookie
function eraseCookie(name) {
  // check if cookie exists locally or httponly
  if(typeof(readCookie(name, 1)) === 'undefined' ) {
    createCookie(name,"",-1, 1);
  }
  else {
    createCookie(name,"",-1);
  }
  delete epcookies[name];
}

// scroll to backorder message in basket if on mobile
jq(document).ready(function () {
  var backorderBoxes = jq("#BasketForm .Basket input:checkbox[name=IC_IsBackorderConfirmed]");
  backorderBoxes.click(function() {
    jq(this).prop("checked") ? jq(this).removeClass('ui-invalid') : jq(this).addClass('ui-invalid');
  });
  jq('#BasketForm').submit( function(e) {
    // Do scrolling on mobile only
    if( jq('.MobileMenu').is(":visible") ) {
      var uncheckedBackorderCheckboxes = jq("#BasketForm .Basket input:checkbox:not(:checked)[name=IC_IsBackorderConfirmed]");
      if( uncheckedBackorderCheckboxes.length > 0 ) {
        var FirstCheckbox = jq(uncheckedBackorderCheckboxes[0]);
        var ProductItem = FirstCheckbox.parents('.ProductItem');
        if( ProductItem.length > 0 ) {
          e.preventDefault();
          FirstCheckbox.addClass('ui-invalid');
          jq('html,body').animate(
          {
            scrollTop:ProductItem.offset().top - 10
          },
          {
            duration: 500,
            complete: function() { jq('.ep-busy').hide(); }
          });
        }
      }
    }
  });
});

function checkBusyScreen(doHide) {
  if( jq('.ep-busy').is(":visible") ) {
    if( typeof(doHide) != 'undefined' && doHide == 1 ) {
      jq('.ep-busy').hide();
      setTimeout(checkBusyScreen, 2000);
    }
    else
    {
      jq('.ep-busy').click( function() { jq(this).hide(); } );
      setTimeout(function(){checkBusyScreen(1);}, 15000);
    }
  }
  else
  {
    setTimeout(checkBusyScreen, 1000);
  }
}

// Hide busy screen if something weird happened
jq(document).ready(function () {
  checkBusyScreen();
});

// Close the search filters on mobile and move them to another div for better user experience
jq(document).ready(function () {
  setMobileOrDesktopMode();
  checkFilterStatusAndPlaceFilter();
});

require([
  "jquery",
  "ep",
], function ($, ep){
    jq(window).on("IC_FacetAjaxReload", function() {
      checkFilterStatusAndPlaceFilter();

      /* BROE-356 Show More Button */
      if (ep.config.Shop_IsEndlessScrollingEnabled){
        //check if ie 8 or below
        if (!jq('html').hasClass('ie8') && !jq('html').hasClass('ie7') && !jq('html').hasClass('ie6')){
          jq('.IC_LoadMoreButton').addClass('active');
          jq('.PagerTable').last().css('display','none');
        }
      }

      /* BROE-295 View more button */
      ICSetupViewMoreButton();

      if (ep.config.Shop_IsRealTimeStockUpdateEnabled) { // variable set in DE_EPAGES/Design/Templates/SF/SF.Script-JQuery.html
        ICUpdateAndProcessListProducts();
      }

      IC_InitProductListEvents();
      setMobileQuickAccessFilter();
    });
    
    jq(window).on("resize", function(){
      jq(".ui-dialog-content").dialog("option","position", {
        my: "center",
        at: "center",
        of: window,
        collision: "fit"});
    });
  }
);

// Display filter in left navbar
function resetDesktopFilters() {
  jq(".RemoteSearchFacets").prependTo(".NavBarLeft .SizeContainer");
  jq(".RemoteSearchFacets .RemoteSearchFacet").not(".RemoteSearchFacetCategory, .RemoteSearchFacetFilter").removeClass("IC_FacetCollapseClosed").addClass("IC_FacetCollapseOpen");
  jq(".RemoteSearchFacets .RemoteSearchFacet .IC_FacetContent").css("display","block");
  jq(".RemoteSearchFacetFilter > ul").css("display","inherit");
}

function checkFilterStatusAndPlaceFilter() {
  if( window.oldVisibility != jq('.MobileMenu').is(':visible') ) {
    if( jq('.MobileMenu').is(':visible') ) {
      jq('.RemoteSearchFacetFilter .RemoteSearchFacet').not('.IC_IsUsed').removeClass('IC_FacetCollapseOpen').addClass('IC_FacetCollapseClosed');
      jq('.RemoteSearchFacetFilter .RemoteSearchFacet.IC_FacetCollapseClosed .IC_FacetContent').hide();
      jq('.RemoteSearchFacets').appendTo('.MobileFilterMenu');

      changeSearchActionBarLocation();
    }
    else
    {
      resetDesktopFilters();
    }
  }
  window.oldVisibility = jq('.MobileMenu').is(":visible");
}

function changeSearchActionBarLocation(){
  jq(".RemoteSearchFacetSelectBrownells_Make .IC_FacetContent").html("");
  jq(".IC_SearchActionBar .IC_ShopByFirearm_Make").appendTo(".RemoteSearchFacetSelectBrownells_Make .IC_FacetContent");

  jq(".RemoteSearchFacetSelectBrownells_Model .IC_FacetContent").html("");
  jq(".IC_SearchActionBar .IC_ShopByFirearm_Model").appendTo(".RemoteSearchFacetSelectBrownells_Model .IC_FacetContent");

  jq(".RemoteSearchFacetSelectManufacturer .IC_FacetContent").html("");
  jq(".IC_SearchActionBar .IC_ShopByFirearm_Manufacturer").appendTo(".RemoteSearchFacetSelectManufacturer .IC_FacetContent");

  var labelSearchWithText = jq('.IC_SearchWithin input[type=text]').attr('placeholder');

  if (jq('.RemoteSearchFacetFilter').length == 0){
    if (jq('.IC_SearchWithin input[type=text]').val() != ''){
      //To-DO
      jq('.MobileFilterMenu #RemoteSearchFacets ul:first').append('<li class="RemoteSearchFacet RemoteSearchFacetFilter"><span class="FacetName">'+jq('.IC_searchFilterText').val()+'</span><ul></ul></li>');
    }
  }

    jq('.RemoteSearchFacetFilter > ul').append('<li class="RemoteSearchFacet RemoteSearchFacetSelect IC_SearchWithinHeader IC_NonCatFacet  IC_IsUsed IC_FacetCollapseOpen"><span class="FacetName">'+labelSearchWithText+'<span class="IC_FacetCollapseButton"></span></span><div class="IC_FacetContent"  style="display: block;"></div></li>');
    jq(".IC_SearchActionBar .IC_SearchWithinHeader").appendTo(".RemoteSearchFacetFilter .IC_SearchWithinHeader .IC_FacetContent");

  jq('.RemoteSearchFacetFilter .IC_SearchWithinHeader .FacetName:not(.alreadybound)').bind('click', function() {
    FacetCollapse(this);
  });
  jq('.RemoteSearchFacetFilter .IC_SearchWithinHeader .FacetName:not(.alreadybound)').addClass('alreadybound');

  //Remove hidden fields, required in desktop mode only
  jq('.RemoteSearchFacets input[name='+jq('.IC_ShopByFirearm_Make').attr("name")+']').remove();
  jq('.RemoteSearchFacets input[name='+jq('.IC_ShopByFirearm_Model').attr("name")+']').remove();

  if (jq('.RemoteSearchFacetFilter .RemoteSearchFacet.IC_IsUsed').length > 0){
        jq('.RemoteSearchFacetFilter .FacetName').addClass('open');
        jq('.IC_ViewAllFilters').show();
  }
  else{
    jq('.RemoteSearchFacets .RemoteSearchFacet .IC_FacetContent')
       .css('display','none');
    jq('.RemoteSearchFacetFilter > ul')
       .css('display','none');
  }
}

// BROE-339 A/B-Testing
function isDevSystem(){
  var patt = new RegExp("dev-brownells.*\.[a-z]{2,3}","g")
    if (patt.test(window.location.hostname)) {
      return true;
    }
  return false;
}

// BROE-339 A/B-Testing
function testOptimizeCookie(testID, variantNo){
  var gaVariant = readCookie("_gaexp");
  if (gaVariant != null){
    var patt = new RegExp(testID+"\\..+\\."+variantNo,"g")
    if (patt.test(gaVariant)) {
      return true;
    }
  }
  return false;
}

// update the viewport based on the devices height, orientation and cookie (useDesktopVersion) setting
function setMobileOrDesktopMode() {
  if(readCookie('useDesktopVersion') === 'true') {
    createCookie('useDesktopVersion','true',7);
  }
  else if(readCookie('useDesktopVersion') === 'false') {
    createCookie('useDesktopVersion','false',7);
  }
  else {
    if( isMobileMode() ) {
      createCookie('useDesktopVersion','false',7);
    }
    else if( isDesktopMode() )
    {
      createCookie('useDesktopVersion','true',7);
    }
  }
}

//mobile only: productdetails - if the decription is larger than 200px, the text gets shortened and a read more button is being displayed
jq(document).ready(function(){
  if (jq('.ProductInfoTabsMobile .description').length) {
    jq('.ProductInfoTabsMobile .description').each(function( idx, val ){
      // wrap DynamicDescriptionbox around
      var oldCss = jq(this).parent().attr("style");
      //required to get the height of display:none
      jq(this).parent().css({
        'position':'absolute',
        'visibility':'hidden',
        'display':'block'
      });
      rmb = jq(this);
      rmb.addClass('DynamicDescriptionBox');
      if(rmb.height() > 200 && (rmb.height()+30)>260) {
        rmb.css({ height: rmb.height() });
        rmb.toggleClass('closed', 1);
        rmb.parent().find(".IC_ReadMoreLink").removeClass("HiddenOnMobile");
     }
     //reset style
     jq(this).parent().attr("style", oldCss ? oldCss : "");
    });
  }
});



function forceReload() {
  var queryString = document.location.search + '';
  queryString = queryString.replace(/(\?|&)r=\d+/g,'')
  if( queryString !== '' ) {
    queryString += '&';
  }
  else
  {
    queryString += '?';
  }
  queryString += "r="+new Date().getTime();
  window.location.href = document.location.pathname + queryString;
}

function addMobileSubMenuClickEvents() {
  //expand the mobile menu further by clicking on the list item
  jq('.MobileMenu .IC_MenuText').click(function(e){
    e.preventDefault();
    $this = jq(this);
    $parent = $this.parent();
    $ulChild = $parent.children("ul").first();
    $liChildren = $parent.children(".IC_CategorySubMenuChildren");
    if( $liChildren.length > 0 ) {
      $ulChild.append($liChildren.html());
      $liChildren.remove();
    }
    $ulChild.toggle();
    $this.toggleClass("Expanded");
  });
}

jq(document).ready(function(){

  //force desktop mode on mobile device
  jq('.IC_GotoDesktopLink').click(function(e){
    e.preventDefault();
    createCookie('useDesktopVersion','true',7);
    forceReload();
    return false;
  });

  //stop forcing desktop mode on mobile device
  jq('.IC_GotoMobileLink').click(function(e){
    e.preventDefault();
    createCookie('useDesktopVersion','false',7);
    forceReload();
    return false;
  });

  //click on backtotop button makes the site jump back to the top
  jq('.backtotop').click(function(e){
    jq('body,html').animate({
      scrollTop: 0
    }, 800);
    return false;
  });

  //mobile only: productdetails - click on "read more" button displays the full content of description and hides the read more button
  jq('.IC_ReadMoreLink').click(function(e){
    jq(this).parent().find('.description').removeClass('closed DynamicDescriptionBox');
    jq(this).addClass("HiddenOnMobile");
  });

  //click on error messages make them disappear
  jq('.ep-uiValidate-message').click(function(e){
    jq(this).parent().css("display","none");
  });

  //mobile only: click on a letter of the pageination of manufacturers category makes the site jump to the desired selection
  jq('.IC_PagerManufacturersContainer li a').click(function(e){
    jq('html,body').animate({
      scrollTop:jq("#"+jq(this).attr("data-target")).offset().top - 10
    }, 500);
    return false;
  });

  //mobile only: if a new item is being selected using the schematics part selection, the desired part is displayed
  jq('.IC_SchematicsPartSelection').change(function(e){
    jq('html,body').animate({
      scrollTop:jq(".RefNumber"+jq(this).val()).offset().top - 10
    }, 500);
  });

  // Enable the show and hide functionality for mobile menu
  jq('.Div .Header .PropertyContainer .SizeContainer .MobileMenu').click(function(e){
    jq(".Div .NavBarTop").toggle();
  });

  addMobileSubMenuClickEvents();

  jq(".CheckoutSelect .ep-contentBox-check > input[type='radio']").change( function(){
   if( jq(this).is(':checked') )
   {
     jq('.CheckoutSelect li').removeClass('IC_SelectedCartItem');
     jq(this).closest('li').addClass('IC_SelectedCartItem');
   }
  });

  setMobileQuickAccessFilter();

});

//clicking on the MobileFilterMenuQuickAccess takes the user to the filter
function setMobileQuickAccessFilter() {
  jq('.MobileFilterMenuQuickAccess:not(.bound)').click(function(e){
    jq('html,body').animate({
      scrollTop:jq(".MobileFilterMenu").offset().top - 5
    }, 300);
    jq('.MobileFilterMenuQuickAccess').removeClass("HideElement");
    //open the filter:
    jq(".RemoteSearchFacetFilter").children("ul").show();
    jq(".RemoteSearchFacetFilter .FacetName:first-child").toggleClass("open");
  });
  jq('.MobileFilterMenuQuickAccess:not(.bound)').addClass('bound');
}

//display filter shortcut, if filter is visible and scrolled down to results
jq(window).bind('touchmove, scroll',function(){
  if (isMobileMode())
  {
    if (jq('.RemoteSearchFacet').length > 0 && jq('.ProductListImageBox').length > 0){
      if (jq(this).scrollTop() + 50 > jq('.ProductListImageBox:first').offset().top ) {
          jq('.MobileFilterMenuQuickAccess').removeClass("HideElement");
      }
      else {
          jq('.MobileFilterMenuQuickAccess').addClass("HideElement");
      }
    }
  }
});

//set backtotop button status shown / hidden based on the scroll position
jq(window).bind('touchmove, scroll',function(){
  if (jq(this).scrollTop() > 100) {
    jq('.backtotop').fadeIn();
  }
  else {
    jq('.backtotop').fadeOut();
  }
});

// real time stock update
jq(document).ready(function () {
  require([
      "jquery",
      "ep"
   ], function ($, ep){
    if (ep.config.Shop_IsRealTimeStockUpdateEnabled) { // variable set in DE_EPAGES/Design/Templates/SF/SF.Script-JQuery.html
      ICUpdateAndProcessProductDetails(); // product details
      ICUpdateAndProcessListProducts(); // list products at product page (cross selling), category view, search result page, and schematics
    }
  });
});

function ICUpdateAndProcessListProducts() {
  var productIDs = new Array();
  var rangeIDs = new Array();
  jq('div.ProductListImageBox:not(.alreadybound)').each(function(){
    if(typeof(jq(this).attr('id')) != 'undefined'){
      var productID = jq(this).attr('id').substr(19);
      if(productID != '') {
        productIDs.push(productID);

        if(jq('.ContentArea .HasGrouping').length > 0 && jq(this).hasClass('HasPriceRange')) {
          rangeIDs.push(productID);
        }
      }
    }
  });
  if (productIDs.length == 0) return;
  jq('div.ProductListImageBox:not(.alreadybound) div.StockText').addClass('IsLoading');

  /* BROE-356 */
  if (ep.config.Shop_IsEndlessScrollingEnabled){
    //do this no matter if it fails or not
    jq('div.ProductListImageBox:not(.alreadybound)').addClass('alreadybound');
  }

  var currentDate = new Date();
  var currentTimestamp = currentDate.getTime();
  jq.ajax({
    url      : ep.config.storeFrontUrl.replace(new RegExp('\\.sf$'), '.stock/?t=' + currentTimestamp ),
    cache    : false,
    type     : 'post',
    dataType : 'json',
    timeout  : 2000,
    data     : {
      ObjectID   : ep.config.siteId,
      ViewAction : 'JSONUpdateAndProcessListProducts',
      Language   : ep.config.language,
      ProductIDs : productIDs.join(','),
      RangeIDs : rangeIDs.join(',')
    },
    success  : function(data) {
      for (var productID in data) {
        if (data[productID] != '') jq('div.ProductListImageBox[id=ProductListImageBox'+productID+'] div.StockText').html(data[productID]);
      }
      jq('div.ProductListImageBox div.StockText').removeClass('IsLoading');
    },
    error    : function(data) {
      jq('div.ProductListImageBox div.StockText').removeClass('IsLoading');
    }
  });
}

function ICUpdateAndProcessProductDetails() {
  var productIDs = new Array();
  jq('div.IC_PriceAndBasket').each(function(){
    productIDs.push(jq(this).attr('id').substr(17));
  });
  if (productIDs.length == 0) return;
  if (productIDs.length > 0) {
    jq('div.IC_PriceAndBasket div.IC_Stock').children().hide();
    jq('div.IC_PriceAndBasket br').show();
    jq('div.IC_PriceAndBasket img.ICStockLoadIndicator').show();

    var currentDate = new Date();
    var currentTimestamp = currentDate.getTime();
    jq.ajax({
      url      : ep.config.storeFrontUrl.replace(new RegExp('\\.sf$'), '.stock/?t=' + currentTimestamp),
      cache    : false,
      type     : 'post',
      dataType : 'json',
      timeout  : productIDs.length > 5  ?  4000 : 2000,
      data     : {
        ObjectID        : ep.config.siteId,
        ViewAction      : 'JSONUpdateAndProcessProductDetails',
        Language        : ep.config.language,
        ProductIDs      : productIDs.join(','),
        IC_IsDetailView : 1
      },
      success  : function(data) {
        for (var productID in data) {
          if (data[productID] == '') jq('div.IC_PriceAndBasket[id=IC_PriceAndBasket'+productID+']').closest('div.IC_ProductBox').hide();
          else jq('div.IC_PriceAndBasket[id=IC_PriceAndBasket'+productID+']').html(data[productID]);
        }
        jq('div.IC_PriceAndBasket div.IC_Stock').children().show();
        jq('div.IC_PriceAndBasket img.ICStockLoadIndicator').hide();
      },
      error    : function(data) {
        jq('div.IC_PriceAndBasket div.IC_Stock').children().show();
        jq('div.IC_PriceAndBasket img.ICStockLoadIndicator').hide();
      }
    });
  }
}

// BROE-295 ViewMore / ViewLess Button
function ICSetupViewMoreButton() {
  jq('.IC_FacetViewBtn.IC_More').click(function(e){
    e.preventDefault();
    jq(this).next().show();
    jq(this).hide();
    jq(this).parent().siblings('.IC_FacetValuesHidden').show();
  });

  jq('.IC_FacetViewBtn.IC_Less').click(function(e){
    e.preventDefault();
    jq(this).prev().show();
    jq(this).hide();
    jq(this).parent().siblings('.IC_FacetValuesHidden').hide();
  });

  jq('.NavBarLeft li.RemoteSearchFacet.IC_NonCatFacet .FacetName:not(.alreadybound), .MobileFilterMenu li.RemoteSearchFacet.IC_NonCatFacet .FacetName:not(.alreadybound)').click(function(e) {
    FacetCollapse(this);
  });

  jq('.NavBarLeft li.RemoteSearchFacet.IC_NonCatFacet .FacetName:not(.alreadybound)').addClass('alreadybound');
  jq('.MobileFilterMenu li.RemoteSearchFacet.IC_NonCatFacet .FacetName:not(.alreadybound)').addClass('alreadybound');
}

function FacetCollapse(thisVar){
  var jqFacetListEntry = jq(thisVar).parent();
  if(jqFacetListEntry.hasClass('IC_FacetCollapseClosed')) {
    jqFacetListEntry.addClass('IC_FacetCollapseOpen').removeClass('IC_FacetCollapseClosed');
    jq(thisVar).next().slideDown(200);
  }
  else {
    jqFacetListEntry.addClass('IC_FacetCollapseClosed').removeClass('IC_FacetCollapseOpen');
    jq(thisVar).next().slideUp(200);
  }
}

/*!
 * jQuery UI Touch Punch 0.2.3
 *
 * Copyright 2011–2014, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */
require([
  "jquery",
  "jquery/ui/mouse",
], function(a){

  function f(a, b) {
        if (!(a.originalEvent.touches.length > 1)) {
            a.preventDefault();
            var c = a.originalEvent.changedTouches[0],
                d = document.createEvent("MouseEvents");
            d.initMouseEvent(b, !0, !0, window, 1, c.screenX, c.screenY, c.clientX, c.clientY, !1, !1, !1, !1, 0, null), a.target.dispatchEvent(d)
        }
    }
   if (a.support.touch = "ontouchend" in document, a.support.touch) {
        var e, b = a.ui.mouse.prototype,
            c = b._mouseInit,
            d = b._mouseDestroy;
        b._touchStart = function(a) {
            var b = this;
            !e && b._mouseCapture(a.originalEvent.changedTouches[0]) && (e = !0, b._touchMoved = !1, f(a, "mouseover"), f(a, "mousemove"), f(a, "mousedown"))
        }, b._touchMove = function(a) {
            e && (this._touchMoved = !0, f(a, "mousemove"))
        }, b._touchEnd = function(a) {
            e && (f(a, "mouseup"), f(a, "mouseout"), this._touchMoved || f(a, "click"), e = !1)
        }, b._mouseInit = function() {
            var b = this;
            b.element.bind({
                touchstart: a.proxy(b, "_touchStart"),
                touchmove: a.proxy(b, "_touchMove"),
                touchend: a.proxy(b, "_touchEnd")
            }), c.call(b)
        }, b._mouseDestroy = function() {
            var b = this;
            b.element.unbind({
                touchstart: a.proxy(b, "_touchStart"),
                touchmove: a.proxy(b, "_touchMove"),
                touchend: a.proxy(b, "_touchEnd")
            }), d.call(b)
        }
    }
});

/* BROE 296 */
function IC_GetViewMakeModel(makeId, make){
  var ajaxUrl = [location.protocol, '//', location.host, location.pathname].join('');
  if (typeof(ep) != 'undefined'){
    ajaxUrl = ep.config.storeFrontUrl;
  }

  jq('.IC_ShopByFirearm_Model').prop('disabled', true);
  jq('.IC_ShopByFirearmGo').addClass('blocked');
  jq('.IC_Loader').addClass('active');
  jq('.IC_ShopByFirearmGo').css('display','none');
  jq.ajax({
    url: ajaxUrl,
    data: {
      ViewAction : 'AJAX-IC_IncludeTemplate',
      IC_Template : 'INC-IC_ViewMakeModel',
      Make : encodeURIComponent(make),
      MakeId : makeId
    },
    async: false,
    cache: false,
    context: document.body,
    success: function(data){
      jq('.IC_ShopByFirearm_Model')
       .find('option')
       .remove()
       .end()
       .append(data);
      jq('.IC_ShopByFirearm_Model').prop('disabled', false);
      jq('.IC_ShopByFirearmGo').css('display','inherit');
      jq('.IC_Loader').removeClass('active');
      jq('.IC_ShopByFirearmGo').removeClass('blocked');
    }
  });
}

/* BROE-175 */
/*================================================================================================
 Description:  Initializing submit button of the rate order process on document ready.
==================================================================================================*/
jq(document).ready(function(){
  jq('.SubmitOrderRating:not(.disabled)').click(function(e){
    IC_GetProcessRating();
  });
});

/*================================================================================================
 Description:  This function processes the "Rate Shopping Experience" form and triggers the e-mail
               event. If less than 4 stars were given by the user he is required to leave a reason
               why he is not satisfied with the shopping experience.
==================================================================================================*/
function IC_GetProcessRating(){
  if(!jq('.SubmitOrderRating').hasClass('disabled')){
    if(jq('.rateit').rateit('value') < 1) {
      jq('#ProcessRateError').fadeIn();
      return false;
    }

    if(jq('.rateit').rateit('value') < 4 && jq('#ProcessRatingText textarea').val().length == 0) {
      jq('#ProcessRatingText p').addClass('required');
      return false;
    }

    var form = jq('#ProcessRatingForm');
    var ajaxUrl = [location.protocol, '//', location.host, location.pathname].join('');
    if (typeof(ep) != 'undefined'){
      ajaxUrl = ep.config.baseUrl;
    }

    ajaxUrl += '?ViewAction=AJAX-IC_IncludeTemplate&IC_Template=INC-IC_ProcessRating&ChangeAction=ICSendProcessRating';

    jq('.SubmitOrderRating').addClass('disabled');

    jq.ajax({
      url: ajaxUrl,
      type: 'post',
      dataType: 'html',
      data: jq(form).serialize(),
      success: function(data) {
        jq('#ProcessRatingContent').css('display','none');
        jq('.SubmitOrderRating').html(data);
      }
    });
  }
  return false;
}

/*================================================================================================
 Description:  This function manages the look of the rate it slider which is being displayed after
               checkout. It is replacing the slider with stars to make it look more beautiful.
==================================================================================================
 RateIt | v1.1.0 / 10/20/2016
 https://github.com/gjunge/rateit.js | Twitter: @gjunge
==================================================================================================*/
!function(e){function t(e){var t=e.originalEvent.changedTouches,a=t[0],i="";switch(e.type){case"touchmove":i="mousemove";break;case"touchend":i="mouseup";break;default:return}var r=document.createEvent("MouseEvent");r.initMouseEvent(i,!0,!0,window,1,a.screenX,a.screenY,a.clientX,a.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(r),e.preventDefault()}e.rateit={aria:{resetLabel:"reset rating",ratingLabel:"rating"}},e.fn.rateit=function(a,i){var r=1,n={},s="init",d=function(e){return e.charAt(0).toUpperCase()+e.substr(1)};if(0===this.length)return this;var l=e.type(a);if("object"==l||void 0===a||null===a)n=e.extend({},e.fn.rateit.defaults,a);else{if("string"==l&&"reset"!==a&&void 0===i)return this.data("rateit"+d(a));"string"==l&&(s="setvalue")}return this.each(function(){var l=e(this),o=function(e,t){if(null!=t){var a="aria-value"+("value"==e?"now":e),i=l.find(".rateit-range");void 0!=i.attr(a)&&i.attr(a,t)}return arguments[0]="rateit"+d(e),l.data.apply(l,arguments)};if("reset"==a){var u=o("init");for(var v in u)l.data(v,u[v]);if(o("backingfld")){var m=e(o("backingfld"));"SELECT"==m[0].nodeName&&"index"===m[0].getAttribute("data-rateit-valuesrc")?m.prop("selectedIndex",o("value")):m.val(o("value")),m.trigger("change"),m[0].min&&(m[0].min=o("min")),m[0].max&&(m[0].max=o("max")),m[0].step&&(m[0].step=o("step"))}l.trigger("reset")}l.hasClass("rateit")||l.addClass("rateit");var h="rtl"!=l.css("direction");if("setvalue"==s){if(!o("init"))throw"Can't set value before init";if("readonly"!=a||1!=i||o("readonly")||(l.find(".rateit-range").unbind(),o("wired",!1)),"value"==a&&(i=null==i?o("min"):Math.max(o("min"),Math.min(o("max"),i))),o("backingfld")){var m=e(o("backingfld"));"SELECT"==m[0].nodeName&&"index"===m[0].getAttribute("data-rateit-valuesrc")?"value"==a&&m.prop("selectedIndex",i):"value"==a&&m.val(i),"min"==a&&m[0].min&&(m[0].min=i),"max"==a&&m[0].max&&(m[0].max=i),"step"==a&&m[0].step&&(m[0].step=i)}o(a,i)}if(!o("init")){if(o("mode",o("mode")||n.mode),o("icon",o("icon")||n.icon),o("min",isNaN(o("min"))?n.min:o("min")),o("max",isNaN(o("max"))?n.max:o("max")),o("step",o("step")||n.step),o("readonly",void 0!==o("readonly")?o("readonly"):n.readonly),o("resetable",void 0!==o("resetable")?o("resetable"):n.resetable),o("backingfld",o("backingfld")||n.backingfld),o("starwidth",o("starwidth")||n.starwidth),o("starheight",o("starheight")||n.starheight),o("value",Math.max(o("min"),Math.min(o("max"),isNaN(o("value"))?isNaN(n.value)?n.min:n.value:o("value")))),o("ispreset",void 0!==o("ispreset")?o("ispreset"):n.ispreset),o("backingfld")){var m=e(o("backingfld")).hide();if((m.attr("disabled")||m.attr("readonly"))&&o("readonly",!0),"INPUT"==m[0].nodeName&&("range"!=m[0].type&&"text"!=m[0].type||(o("min",parseInt(m.attr("min"))||o("min")),o("max",parseInt(m.attr("max"))||o("max")),o("step",parseInt(m.attr("step"))||o("step")))),"SELECT"==m[0].nodeName&&m[0].options.length>1){"index"===m[0].getAttribute("data-rateit-valuesrc")?(o("min",isNaN(o("min"))?Number(m[0].options[0].index):o("min")),o("max",Number(m[0].options[m[0].length-1].index)),o("step",Number(m[0].options[1].index)-Number(m[0].options[0].index))):(o("min",isNaN(o("min"))?Number(m[0].options[0].value):o("min")),o("max",Number(m[0].options[m[0].length-1].value)),o("step",Number(m[0].options[1].value)-Number(m[0].options[0].value)));var c=m.find("option[selected]");1==c.length&&("index"===m[0].getAttribute("data-rateit-valuesrc")?o("value",c[0].index):o("value",c.val()))}else o("value",m.val())}var g="DIV"==l[0].nodeName?"div":"span";r++;var f='<button id="rateit-reset-{{index}}" type="button" data-role="none" class="rateit-reset" aria-label="'+e.rateit.aria.resetLabel+'" aria-controls="rateit-range-{{index}}"><span></span></button><{{element}} id="rateit-range-{{index}}" class="rateit-range" tabindex="0" role="slider" aria-label="'+e.rateit.aria.ratingLabel+'" aria-owns="rateit-reset-{{index}}" aria-valuemin="'+o("min")+'" aria-valuemax="'+o("max")+'" aria-valuenow="'+o("value")+'"><{{element}} class="rateit-empty"></{{element}}><{{element}} class="rateit-selected"></{{element}}><{{element}} class="rateit-hover"></{{element}}></{{element}}>';l.append(f.replace(/{{index}}/gi,r).replace(/{{element}}/gi,g)),h||(l.find(".rateit-reset").css("float","right"),l.find(".rateit-selected").addClass("rateit-selected-rtl"),l.find(".rateit-hover").addClass("rateit-hover-rtl")),"font"==o("mode")?l.addClass("rateit-font").removeClass("rateit-bg"):l.addClass("rateit-bg").removeClass("rateit-font"),o("init",JSON.parse(JSON.stringify(l.data())))}var p="font"==o("mode");p||l.find(".rateit-selected, .rateit-hover").height(o("starheight"));var b=l.find(".rateit-range");if(p){for(var x=o("icon"),w=o("max")-o("min"),N="",y=0;y<w;y++)N+=x;b.find("> *").text(N),o("starwidth",b.width()/(o("max")-o("min")))}else b.width(o("starwidth")*(o("max")-o("min"))).height(o("starheight"));var C="rateit-preset"+(h?"":"-rtl");if(o("ispreset")?l.find(".rateit-selected").addClass(C):l.find(".rateit-selected").removeClass(C),null!=o("value")){var k=(o("value")-o("min"))*o("starwidth");l.find(".rateit-selected").width(k)}var E=l.find(".rateit-reset");E.data("wired")!==!0&&E.bind("click",function(t){t.preventDefault(),E.blur();var a=e.Event("beforereset");return l.trigger(a),!a.isDefaultPrevented()&&(l.rateit("value",null),void l.trigger("reset"))}).data("wired",!0);var M=function(t,a){var i=a.changedTouches?a.changedTouches[0].pageX:a.pageX,r=i-e(t).offset().left;return h||(r=b.width()-r),r>b.width()&&(r=b.width()),r<0&&(r=0),k=Math.ceil(r/o("starwidth")*(1/o("step")))},I=function(e){var t=e*o("starwidth")*o("step"),a=b.find(".rateit-hover");if(a.data("width")!=t){b.find(".rateit-selected").hide(),a.width(t).show().data("width",t);var i=[e*o("step")+o("min")];l.trigger("hover",i).trigger("over",i)}},L=function(t){var a=e.Event("beforerated");return l.trigger(a,[t]),!a.isDefaultPrevented()&&(o("value",t),o("backingfld")&&("SELECT"==m[0].nodeName&&"index"===m[0].getAttribute("data-rateit-valuesrc")?e(o("backingfld")).prop("selectedIndex",t).trigger("change"):e(o("backingfld")).val(t).trigger("change")),o("ispreset")&&(b.find(".rateit-selected").removeClass(C),o("ispreset",!1)),b.find(".rateit-hover").hide(),b.find(".rateit-selected").width(t*o("starwidth")-o("min")*o("starwidth")).show(),l.trigger("hover",[null]).trigger("over",[null]).trigger("rated",[t]),!0)};o("readonly")?E.hide():(o("resetable")||E.hide(),o("wired")||(b.bind("touchmove touchend",t),b.mousemove(function(e){var t=M(this,e);I(t)}),b.mouseleave(function(e){b.find(".rateit-hover").hide().width(0).data("width",""),l.trigger("hover",[null]).trigger("over",[null]),b.find(".rateit-selected").show()}),b.mouseup(function(e){var t=M(this,e),a=t*o("step")+o("min");L(a),b.blur()}),b.keyup(function(e){38!=e.which&&e.which!=(h?39:37)||L(Math.min(o("value")+o("step"),o("max"))),40!=e.which&&e.which!=(h?37:39)||L(Math.max(o("value")-o("step"),o("min")))}),o("wired",!0)),o("resetable")&&E.show()),b.attr("aria-readonly",o("readonly"))})},e.fn.rateit.defaults={min:0,max:5,step:.5,mode:"bg",icon:"?",starwidth:16,starheight:16,readonly:!1,resetable:!0,ispreset:!1},e(function(){e("div.rateit, span.rateit").rateit()})}(jQuery);

/* END BROE-175 */

/*================================================================================================
 Description:  Calling IC_InitializeSearchActions on document ready.
==================================================================================================*/
jq(document).ready(function(){
  IC_InitializeSearchActions();
});

/*================================================================================================
 Description:  This function initializes all events required for search action bar. It is also
               enabling a fix for older IE browsers which do not support placeholders.
==================================================================================================*/
function IC_InitializeSearchActions(){
  jq('.RemoteSearchFacetFilter > .FacetName:not(.alreadybound)').click( function() {
    if (isMobileMode()){
      jq(this).parent().children('ul').toggle();
      jq(this).parent().children('span').toggleClass('open');
      if (jq('.RemoteSearchFacetFilter > .FacetName').hasClass('open')) {
        jq(this).parent().children('.IC_ViewAllFilters').show();
      }
      else {
        jq(this).parent().children('.IC_ViewAllFilters').hide();
      }
    }
  });
  jq('.RemoteSearchFacetFilter > .FacetName:not(.alreadybound)').addClass('alreadybound')

  jq('.IC_SearchWithinHeader .IC_SearchWithinButton:not(.alreadybound)').click(function(){
    SearchWithinSearch();
  });
  jq('.IC_SearchWithinHeader .IC_SearchWithinButton:not(.alreadybound)').addClass('alreadybound');

  jq('.IC_ModelMakeButton:not(.alreadybound)').click(function(){
    SearchChangeMakeModel();
  });
  jq('.IC_ModelMakeButton:not(.alreadybound)').addClass('alreadybound');

  if (!isMobileMode()){
    jq('.IC_SearchWithinHeader .IC_SearchWithin input[type=text]:not(.alreadybound)').keyup(function(event){
      if(event.keyCode == 13){
        SearchWithinSearch();
      }
    });
    jq('.IC_SearchWithinHeader .IC_SearchWithin input[type=text]:not(.alreadybound)').addClass('alreadybound');
  }

  jq('.IC_ViewAllFilters a:not(.alreadybound)').click( function() {
    jq('.RemoteSearchFacets form').prepend('<input type="hidden" name="ICShowAllFacets" value="1"/>');
    jq('.RemoteSearchFacets form').trigger('submit');
  });
  jq('.IC_ViewAllFilters a:not(.alreadybound)').addClass('alreadybound');

  /* IE 8 / 9 Fix for placeholder */
  if (isIE()){
    jq('[placeholder]').each(function(index){
      if (jq(this).val() == ''){
        jq(this).val( jq(this).attr('placeholder'));
        jq(this).addClass('placeholder');
      }

      jq(this).focus(function(){
        if ( jq(this).val() == jq(this).attr('placeholder') ){
          jq(this).val('');
          jq(this).removeClass('placeholder');
        }
      });

      jq(this).blur(function(){
        if ( jq(this).val() == '' ){
          jq(this).val( jq(this).attr('placeholder'));
          jq(this).addClass('placeholder');
        }
      });

      jq(this).parents('form').submit(function (){
        jq(this).find('[placeholder]').each(function(){
          if ( jq(this).val() == jq(this).attr('placeholder') ) jq(this).val('');
        });
      });
    });
  }
}

/*================================================================================================
 Description:  This function checks if IE is used.
==================================================================================================*/
function isIE(){
  var ua = window.navigator.userAgent;
  ms_ie = !!ua.match(/MSIE|Trident/)
  return ms_ie;
}

/*================================================================================================
 Description:  This function filters URL parameter array with the passed filters and returns the
               new filtered URL parameter string.
==================================================================================================*/
function IC_FilterUrlParams(paramArray, filter){
  var NewUrl = '';
  if (paramArray != null){
    paramArray.forEach(function(param) {
      var reg = /(.*)?=(.*)/g;
      var o = reg.exec(param);
      if (filter.indexOf(o[1]) == -1){
        NewUrl +='&'+o[1]+'='+o[2];
      }
    });
  }
  return NewUrl;
}

/*================================================================================================
 Description:  This function updates the search within string and submits the facets form after
               it has updated the form.
==================================================================================================*/
function SearchWithinSearch(){
  jq('.RemoteSearchFacets input[name=SearchWithinString]').remove();
  jq('.RemoteSearchFacets form').prepend('<input type="hidden" name="SearchWithinString" value="'+jq('.IC_SearchWithinHeader .IC_SearchWithin input[type=text]').val().trim()+'"/>');
  jq('.RemoteSearchFacets form').trigger('submit');
}

/*================================================================================================
 Description:  This function calls the changeSelectFilter with the variables required for make.
               The function is set in SF-FacetedSearchResults.INC-ChangeListOrder.html
 Additional:   The name of the filter is language based.
 To-Do:        We should probably remove the function call from the template and add it to
               the other initializations.
==================================================================================================*/
function SearchChangeMake(){
  var makeFieldName = jq('.IC_ShopByFirearm_Make').attr('name');
  var modelFieldName = jq('.IC_ShopByFirearm_Model').attr('name');
  if (!isMobileMode()){
    jq('.RemoteSearchFacets input[name='+modelFieldName+']').remove(); //additional remove of Model
    changeSelectFilter(makeFieldName.replace('FacetValue_',''), '.IC_ShopByFirearm_Make');
  }
}

/*================================================================================================
 Description:  This function calls the changeSelectFilter with the variables required for model.
               The function is set in SF-FacetedSearchResults.INC-ChangeListOrder.html
 Additional:   The name of the filter is language based.
 To-Do:        We should probably remove the function call from the template and add it to
               the other initializations.
==================================================================================================*/
function SearchChangeModel(){
  var modelFieldName = jq('.IC_ShopByFirearm_Model').attr('name');
  changeSelectFilter(modelFieldName.replace('FacetValue_',''), '.IC_ShopByFirearm_Model');
}

/*================================================================================================
 Description:  This function updates the model and make from search action bar if the desktop mode
               is used. The facet form gets updated and later submitted.
 Additional:   The name of model and make is language based.
==================================================================================================*/
function SearchChangeMakeModel(){
  if (!isMobileMode()){
    var makeFieldName = jq('.IC_ShopByFirearm_Make').attr('name');
    var modelFieldName = jq('.IC_ShopByFirearm_Model').attr('name');
    jq('.RemoteSearchFacets input[name='+makeFieldName+']').remove();
    jq('.RemoteSearchFacets input[name='+modelFieldName+']').remove();

    var elemsToChange = [
                          [makeFieldName,  '.IC_ShopByFirearm_Make'],
                          [modelFieldName, '.IC_ShopByFirearm_Model']
                        ];

    elemsToChange.forEach(function(param) {
      if (jq(param[1]).length > 0 && jq(param[1]).val() != ""  && jq(param[1]).val() != undefined){
        if (jq('.RemoteSearchFacet select[name='+param[0]+']').length > 0){
          jq('.RemoteSearchFacet select[name='+param[0]+']').val(jq(param[1]).val())
        }
        else{
          jq('.RemoteSearchFacets form').prepend('<input type="hidden" name="'+param[0]+'" value="'+jq(param[1]).val()+'"/>');
        }
      }else{
        jq('.RemoteSearchFacet select[name='+param[0]+']').val(jq(param[1]).val());
        if(param[1] == ".IC_ShopByFirearm_Make"){
          jq('.IC_ShopByFirearm_Model').val('');
        }
      }
    });

    jq('.RemoteSearchFacets form').trigger('submit');
  }
}

/*================================================================================================
 Description:  This function calls the changeSelectFilter with the variables required for
               Manufacturer. The function is set in SF-FacetedSearchResults.INC-ChangeListOrder.html
 To-Do:        We should probably remove the function call from the template and add it to
               the other initializations.
==================================================================================================*/
function SearchChangeManufacturer(){
  changeSelectFilter('Manufacturer', '.IC_ShopByFirearm_Manufacturer');
}

/*================================================================================================
 Description:  This function updates the make and model based on search action bars selection.
               After adding or removing the inputs in Facet form, the form is being submitted.
 Additional:   If Make gets deselected, the Model gets deselected by default as well.
==================================================================================================*/
function changeSelectFilter(facetValue, facetClassName){
  if (!isMobileMode()){
    jq('.RemoteSearchFacets input[name=FacetValue_'+facetValue+']').remove();
    if (facetClassName == '.IC_ShopByFirearm_Make' && jq('.IC_ShopByFirearm_Model').length > 0){
      jq('.RemoteSearchFacets input[name='+jq('.IC_ShopByFirearm_Model').attr('name')+']').remove();
      jq('.RemoteSearchFacet select[name='+jq('.IC_ShopByFirearm_Model').attr('name')+']').val('');
    }

    if (jq('.RemoteSearchFacet select[name=FacetValue_'+facetValue+']').length > 0){
      jq('.RemoteSearchFacet select[name=FacetValue_'+facetValue+']').val(jq(facetClassName).val())
    }
    else{
      if (jq(facetClassName).val() != ""){
        jq('.RemoteSearchFacets form').prepend('<input type="hidden" name="FacetValue_'+facetValue+'" value="'+jq(facetClassName).val()+'"/>');
      }
    }

    jq('.RemoteSearchFacets form').trigger('submit');
  }
}

/*================================================================================================
 Description:  On page load the functionality for Shop By Firearm gets initialized. On click of
               the button the user gets redirected to the product listing with activated make and/
               /or model filters.
==================================================================================================*/
jq(document).ready(function(){
  jq('.IC_ShopByFirearmGo').click(function(e){
    require(["ep"], function(ep){
      //var SearchUrl = [ep.config.baseUrl, '?ObjectID='+ep.config.objectId+'&ViewAction=FacetedSearchProducts&ICShowAllFacets=1'].join('');
      var SearchUrl = [ep.config.storeFrontUrl, '?ViewAction=FacetedSearchProducts&ICShowAllFacets=1'].join('');
      if (jq('.IC_ShopByFirearm_Make').val() != null && jq('.IC_ShopByFirearm_Make').val() != ''){
        SearchUrl += '&'+jq('.IC_ShopByFirearm_Make').attr("name")+'='+encodeURIComponent(jq('.IC_ShopByFirearm_Make').val());

        if (jq('.IC_ShopByFirearm_Model').val() != null && jq('.IC_ShopByFirearm_Model').val() != ''){
          SearchUrl += '&'+jq('.IC_ShopByFirearm_Model').attr("name")+'='+encodeURIComponent(jq('.IC_ShopByFirearm_Model').val());
        }
      }
      window.location.href=SearchUrl;
    });
  });
});

/* BROE 356 */
var IC_CurrentESPage    = 0;
/*================================================================================================
 Description:  This function fetches the next products via Ajax and attaches them to HotDealList.
               It is also calling the functions required to initialize the events, update stock
               levels and pager and result infos.
==================================================================================================*/
function IC_FetchNextProducts(){
  jq('.IC_LoadMoreButton').removeClass('active');
  jq('.IC_Loader').addClass('active');

  //get StartPage
  if (IC_CurrentESPage == 0){
    IC_CurrentESPage = IC_FindPagerStart();
  }

  var TmpCurPage = parseInt(IC_CurrentESPage)+1;
  var CurrentUrl = jq('.RemoteSearchFacets form').find(":input[value!=''],:input[name='FacetRange_ListPrice']").serialize() + '&Page='+TmpCurPage;
  m = CurrentUrl.match(/[^&?]*?=[^&?]*/g);
  var NewUrl     = IC_FilterUrlParams(m,['ICShowAllFacets']);
  NewUrl         = ep.config.baseUrl+'?NoFacets=1'+NewUrl;

  // T#131569 Hotfix resultpagehandler not loaded yet
  NewUrl         = NewUrl.replace(/ViewAction=[a-zA-Z0-9]+/, 'ViewAction=JSONSnippet');

  jq.ajax({
    url: NewUrl,
    dataType: 'json',
    context: document.body,
    success: function(data, status, jqXHR){
      var d = document.createElement('div');
      d.innerHTML = data.snippet;

      //Append new items to List
      if (d.getElementsByClassName('HotDealList').length > 0){
        IC_CurrentESPage++;
        jq('.HotDealList').append(d.getElementsByClassName('HotDealList')[0].innerHTML);

        //Hide Pager, upon endless scrolling
        jq('.PagerTable').last().css('display','none');

        IC_InitProductListEvents();
      }

      IC_UpdateResultInfo(d);

      //Update Pager, can be removed if pager should really be disabled
      if (d.getElementsByClassName('IC_Pager').length > 0){
        jq('.IC_Pager').first().html(d.getElementsByClassName('IC_Pager')[0].innerHTML);
      }

      if (ep.config.Shop_IsRealTimeStockUpdateEnabled) {
        ICUpdateAndProcessListProducts();
      }
      jq('.IC_Loader').removeClass('active');
    },
    error: function(data){
      jq('.IC_Loader').removeClass('active');
    }
  });
}

/*================================================================================================
 Description:  This function tries to find the start page and updates the global variable
               IC_CurrentESPage required for Endless Scrolling.
==================================================================================================*/
function IC_FindPagerStart(){
  if (IC_CurrentESPage == 0){
    IC_CurrentESPage = 1;
    if (jq('.IC_Pager .activePage').html() != null){
      IC_CurrentESPage = jq('.IC_Pager .activePage').html();
    }
  }
  return IC_CurrentESPage;
}

/*================================================================================================
 Description:  This function is initialising the events required for product boxes and the load
               more button. It also attaches the pushState event, which pushes the current state
               to history in case a ProductListImageBox is clicked.
==================================================================================================*/
function IC_InitProductListEvents(){
  jq('.IC_LoadMoreButton:not(.bound)').click( function() {
    IC_FetchNextProducts();
  });
  jq('.IC_LoadMoreButton').addClass('bound');

  jq('.HotDealList .ProductListImageBox .h3:not(.alreadybound)').click( function() {
    jq(this).find('a')[0].click();
  });
  jq('.HotDealList .ProductListImageBox .h3').addClass('alreadybound');

  jq('.HotDealList .ProductListImageBox:not(.pushstateupdate)').click( function() {
    var ajaxUrl = '?'+jq('.RemoteSearchFacets form').find(":input[value!='']").serialize();
    history.pushState({
      snippetUrl: ajaxUrl,
      Page: IC_FindPagerStart(),
      PageSize: jq('#ep-PageSize :selected').text(),
      DivHeight: jq('.HotDealList').height(),
      ScrollTop: jq(window).scrollTop()
    }, null, location.href);
  });
  jq('.HotDealList .ProductListImageBox').addClass('pushstateupdate');
}

/*================================================================================================
 Description:  If mobile mode is detected, place the Shop By Firearm div on top of
               IC_StartPageLeftBox. Also bind the ResizeIFrames function to orientation and call
               the function.
==================================================================================================*/
jq(document).ready(function(){
  if (isMobileMode()){
    // BROE-530 no need to move the box, if it's already there
    if(jq('.IC_LeftArea .IC_ShopByFirearm').length == 0) {
      jq('.IC_ShopByFirearm').prependTo(jq('.IC_StartPageLeftBox.IC_Text'));
    }

    jq(window).bind('orientationchange', function(e){
      ResizeIFrames();
    });
    ResizeIFrames();
  }
});

/*================================================================================================
 Description:  The function resizes iframes and resizes them according to the width, keeping the
               aspect ratio.
 Additional:   -20px for padding on start page where the iframes are being used
==================================================================================================*/
function ResizeIFrames(){
  if (jq('.IC_HTMLBanner iframe').length > 0){
    var height = jq('.IC_HTMLBanner iframe').height();
    var width = jq('.IC_HTMLBanner iframe').width();
    var aspect = width / height;
    var resizedHeight, resizedWidth = 0

    if(jq(window).height() < jq(window).width()) {
      resizedHeight = jq(window).height() - 20;
      resizedWidth = resizedHeight * aspect;
    }
    else {
      resizedWidth = jq(window).width() - 20;
      resizedHeight = resizedWidth / aspect;
    }

    jq('.IC_HTMLBanner iframe').attr('height', resizedHeight);
    jq('.IC_HTMLBanner iframe').attr('width', resizedWidth);
  }
}

/*================================================================================================
 Description:  On start pages Shop by Firearm check if a make is selected by selecting one and
               using the history back button. If an entry has been selected, models have to be
               reloaded by calling the function IC_GetViewMakeModel.
==================================================================================================*/
jq(document).ready(function(){
  if (jq('.IC_ShopByFirearm .IC_ShopByFirearm_Make').length > 0){
    if (jq('.IC_ShopByFirearm_Make option:selected').val() != ''){
      IC_GetViewMakeModel(jq('.IC_ShopByFirearm_Make').attr('name'),jq('.IC_ShopByFirearm_Make option:selected').val());
    }
  }
});

/*================================================================================================
 Description:  This function resets all filters expect the ones passed as string array and submits
               the search form to get the results without the passed filters.
==================================================================================================*/
function ResetAllBut(filtersToKeep){
  var filterArray = filtersToKeep.split(',');
  var model       = '';
  if (jq('.IC_ShopByFirearm_Model').length > 0)
    model         = jq('.IC_ShopByFirearm_Model').attr('name');
  var make        = '';
  if (jq('.IC_ShopByFirearm_Model').length > 0)
    make          = jq('.IC_ShopByFirearm_Make').attr('name');

  var block = jq('#RemoteSearchFacets form');
  block.find('input:checkbox, input:radio[name!=ICShowAllFacets]')
    .attr('checked', false);

  if(ep.config.objectId != ep.config.siteId){
    block.find('input[name=ICShowAllFacets]')
      .val('');
  }

  if(jq.inArray('SearchWithinString', filterArray)  == -1){
    block.find('input[name=SearchWithinString]')
      .remove();
  }

  if(jq.inArray('SearchString', filterArray)  == -1){
    block.find('input[name=SearchString]')
      .remove();
  }

  block.find('input:text:not([name=SearchString],[name=SearchWithinString])')
    .val('')
    .trigger('keyup');


  if(jq.inArray('Make', filterArray)  !== -1 || jq.inArray('Model', filterArray)  !== -1){
    if (model != '' && make != '' && jq.inArray('Make', filterArray)  !== -1 && jq.inArray('Model', filterArray)  !== -1){
      block.find('select:not([name='+make+'], [name='+model+'])')
            .val('')
            .trigger('keyup');
    }
    else{
      if (make != '' && jq.inArray('Make', filterArray)  !== -1){
        block.find('select:not([name='+make+'])')
            .val('')
            .trigger('keyup');
      }
      else{
        if (model != '' && jq.inArray('Model', filterArray)  !== -1){
          block.find('select:not([name='+model+'])')
            .val('')
            .trigger('keyup');
        }
        else{
          block.find('select')
            .val('')
            .trigger('keyup');
        }
      }
    }
  }
  else{
    block.find('select')
      .val('')
      .trigger('keyup');
  }

  jq('.RemoteSearchFacets form').trigger('submit');
}

/* BROE-356 */
/*================================================================================================
 Description:  After ep is loaded, the ready function checks if Endless Scrolling is enabled in
               the MBO. If it has been activated, it checks for IE 8 and below as we cannot
               support these at the moment. If all requirements are met, the function
               IC_RestoreScrollingHistoryState is being called.
==================================================================================================*/
jq(document).ready(function() {
  require(["ep"], function(ep){
    if (ep.config.Shop_IsEndlessScrollingEnabled){
      if (!jq('html').hasClass('ie8') && !jq('html').hasClass('ie7') && !jq('html').hasClass('ie6')){
        jq('.IC_LoadMoreButton').addClass('active');
        jq('.PagerTable').last().css('display','none');
        IC_RestoreScrollingHistoryState();
      }
    }
  });
});

var HistoryReloadCount        = 0;
var HistoryReloadCountStart   = 1;
var HistoryReloaderStartPage  = 1;
var HistoryPageSize           = 15;
/*================================================================================================
 Description:  This function checks if there is a history state to restore. If there is one the
               function will try to restore the endless scrolling state before the user navigated
               away. It's updating the global variables and starts the Ajax call to fetch products
               loaded in the previous state. Doing that it's necessary to set the height of
               HotDealList and scroll down to the previous recorded position.
==================================================================================================*/
function IC_RestoreScrollingHistoryState(){
  if (window.history && history.pushState && history.replaceState && 'state' in history) {
    if (typeof(window.history.state) != 'undefined' && window.history.state != null){
      if (typeof(window.history.state.Page) != 'undefined'){

        var StartPage = null;
        var params = IC_ParseQueryString();
        try{
          StartPage = params["Page"];
          if (typeof(StartPage) == 'undefined' || StartPage == null){
            StartPage = 1;
          }
        }
        catch(err){
          StartPage = 1;
        }

        history.scrollRestoration = 'manual';
        jq('.HotDealList').css('height', window.history.state.DivHeight);
        jq(window).scrollTop(window.history.state.ScrollTop);

        var DummyItemCount = (window.history.state.Page-StartPage)*window.history.state.PageSize;
        if (DummyItemCount > 0){
          jq('.IC_LoadMoreButton').removeClass('active');
          jq('.HotDealList').append(IC_GenerateProductPlaceholderDivs('DummyDiv', 'DummyItem', DummyItemCount));
          require(["ep"], function(ep){
            var state = window.history.state;
            IC_CurrentESPage = state.Page;

            var CurrentUrl = jq('.RemoteSearchFacets form').find(":input[value!=''],:input[name='FacetRange_ListPrice']").serialize();
            m = CurrentUrl.match(/[^&?]*?=[^&?]*/g);
            var NewUrl = IC_FilterUrlParams(m,['ICShowAllFacets', 'Page']);
            NewUrl = ep.config.baseUrl+'?NoFacets=1'+NewUrl

            jq('.PagerTable').last().css('display','none');

            HistoryReloaderStartPage  = StartPage;
            HistoryReloadAmount       = state.Page;
            HistoryReloadCountStart   = state.Page;
            HistoryPageSize           = state.PageSize;

            IC_FetchProductsViaAjax(NewUrl,HistoryReloadAmount);
          });
        }
        else{
          jq('.IC_Loader').removeClass('active');
          jq('.HotDealList').css('height', 'auto');
          jq('.HotDealList .DummyDiv').remove();
        }
      }
    }
  }
}

/*================================================================================================
 Description:  This function parses the current URL and allows to look up specific parameters.
==================================================================================================*/
var IC_ParseQueryString = function() {
  var str = window.location.search;
  var objURL = {};
  str.replace(
    new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
    function( $0, $1, $2, $3 ){
      objURL[ $1 ] = $3;
    }
  );
  return objURL;
};

/*================================================================================================
 Description:  This function fetches products via Ajax. After a successful fetch the results are
               being appended to HotDealList, DummyBoxes are removed, stock levels are updated and
               the events required for ProductListImageBoxes are initialized.
               If the Ajax fall should fail because of various reasons such as timeouts, the
               DummyDivs are being replaced by FailedToLoadDummies.
               In either case the function will keep calling itself until the global variable
               HistoryReloadAmount is bigger than HistoryReloaderStartPage.
==================================================================================================*/
function IC_FetchProductsViaAjax(NewUrl,PageNo){
  // T#131569 Hotfix resultpagehandler not loaded yet
  NewUrl = NewUrl.replace(/ViewAction=[a-zA-Z0-9]+/, 'ViewAction=JSONSnippet');
  jq.ajax({
    url: NewUrl+'&Page='+PageNo,
    cache: false,
    dataType: 'json',
    context: document.body,
    success: function(data, status, jqXHR){
      var d = document.createElement('div');
      d.innerHTML = data.snippet;

      if (d.getElementsByClassName('HotDealList').length > 0){
        if (PageNo > HistoryReloaderStartPage){
          jq('.HotDealList .DummyDiv').after(d.getElementsByClassName('HotDealList')[0].innerHTML);
          jq('.DummyDiv').find('.DummyItem:nth-last-child(-n+'+HistoryPageSize+')').remove();
        }
      }

      if (PageNo == HistoryReloadCountStart){
        IC_UpdateResultInfo(d);
        if (d.getElementsByClassName('IC_Pager').length > 0){
          jq('.IC_Pager').first().html(d.getElementsByClassName('IC_Pager')[d.getElementsByClassName('IC_Pager').length-1].innerHTML);
        }
      }

      IC_InitProductListEvents();
      if (ep.config.Shop_IsRealTimeStockUpdateEnabled) {
        ICUpdateAndProcessListProducts();
      }
    },
    error: function(request, status, err){
      jq('.IC_Loader').removeClass('active');
      jq('.HotDealList').css('height', 'auto');

      jq('.HotDealList .DummyDiv').after(IC_GenerateProductPlaceholderDivs('FailedToLoadDiv', 'DummyFailedToLoad', HistoryPageSize));
      jq('.DummyDiv').find('.DummyItem:nth-last-child(-n+'+HistoryPageSize+')').remove();

      if (PageNo == HistoryReloadCountStart){
        var newstrOrg = jq('.IC_LoadMoreButton').html().match(/(.*)\s(\(.*\))/);
        if (newstrOrg != null){
          var startNo = 1;
          if (newstrOrg.length > 0){
            startNo = newstrOrg[2];
            startNo = startNo.replace(/[0-9]/g, HistoryReloadCountStart+1);
            jq('.IC_LoadMoreButton').html(newstrOrg[1]+' '+startNo);
          }
        }
      }
    },
    complete: function(data,status){
      HistoryReloadAmount--;
      if (HistoryReloadAmount > HistoryReloaderStartPage){
        IC_FetchProductsViaAjax(NewUrl,HistoryReloadAmount);
      }
      else{
        jq('.IC_Loader').removeClass('active');
        jq('.HotDealList').css('height', 'auto');
        jq('.HotDealList .DummyDiv').remove();
      }
    }
  });
}

/*================================================================================================
 Description:  This function updates the Pager, Resultinfo text and takes care of the visibility
               of the IC_LoadMoreButton.
==================================================================================================*/
function IC_UpdateResultInfo(d){
  if (d.getElementsByClassName('PagerInfoLeft').length > 0){
    //get start:
    var newstrOrg = jq('.PagerInfoLeft').html().match(/(\w+)\s-\s\w+/);
    if (newstrOrg != null){
      var startNo = 1;
      if (newstrOrg.length > 0)
        startNo = newstrOrg[1];
      var newstr = d.getElementsByClassName('PagerInfoLeft')[0].innerHTML.replace(/\w+(\s-\s\w+)/, startNo+'$1');
      jq('.PagerInfoLeft').html(newstr);
    }
  }

  if (d.getElementsByClassName('IC_ResultsTotal').length > 0 && d.getElementsByClassName('IC_ResultsCurrent').length > 0){
    if (d.getElementsByClassName('IC_LoadMoreButton').length > 0)
      jq('.IC_LoadMoreButton').html(d.getElementsByClassName('IC_LoadMoreButton')[0].innerHTML);

    if (parseInt(d.getElementsByClassName('IC_ResultsTotal')[0].value) > parseInt(d.getElementsByClassName('IC_ResultsCurrent')[0].value)){
      jq('.IC_LoadMoreButton').addClass('active');
    }
    else{
      jq('.IC_LoadMoreButton').removeClass('active');
    }
  }
  else{
    jq('.IC_LoadMoreButton').remove();
  }
}



/*================================================================================================
 Description:  This function generates a Div, which class can vary based on the passed
               variable outerClassName. The created div may have a flexible amount
               (itemCount) of ProductListImageBox divs which class is defined by innerClassName.
==================================================================================================*/
function IC_GenerateProductPlaceholderDivs(outerClassName, innerClassName, itemCount){
  var DummySingleHtml = '<div class="ProductListImageBox '+innerClassName+'"><div class="InfoArea"></div></div>';
  var DummyHtml = '<div class="'+outerClassName+'">';
  for (var i = 1; i <= itemCount; i++) {
    DummyHtml += DummySingleHtml;
  }
  return DummyHtml +='</div>';
}
/* END BROE-356 */


/* Google Mobile Optimization */
jq(document).ready(function() {
  SpecialAttributesClickEvent();
});

/*================================================================================================
 Description:  This function initializes the click event of fake checkboxes within the
               FacetFilter. Clicking the fake checkbox or the respective fake label will either
               add or remove a hidden input to the facet form.
==================================================================================================*/
function SpecialAttributesClickEvent(){
  jq('.RemoteSearchFacetFilter .IC_SpecialAttribute:not(.bound)').click( function(e) {
    if (jq(this).attr('data-name').length > 0 && jq(this).attr('data-value').length > 0 ){
      var attrName = jq(this).attr('data-name');
      var attrValue = jq(this).attr('data-value');
      if (jq('input[name="'+attrName+'"][value="'+attrValue+'"]').length > 0){
        jq('input[name="'+attrName+'"][value="'+attrValue+'"]').remove();
      }
      else
      {
        jq(this).append('<input type="hidden"  name="'+attrName+'" value="'+attrValue.replace(/"/g, '&quot;')+'" />');
      }

      jq('.RemoteSearchFacets form').trigger('submit');
    }
  });
  jq('.RemoteSearchFacetFilter .IC_SpecialAttribute:not(.bound)').addClass('bound');
}
/* Google Mobile Optimization End */

/* BROE 448 */
/*================================================================================================
 Description:  This function does an AJAX call to check if the e-mail addressed already exists.
               If it does exist the user is being informed that he or she already has an account
               and might login instead.
==================================================================================================*/
function IC_FetchEmailRegistered(email){
  var ajaxUrl = [location.protocol, '//', location.host, location.pathname].join('');
  if (typeof(ep) != 'undefined'){
    ajaxUrl = ep.config.baseUrl;
  }

  jq.ajax({
    url: ajaxUrl,
    type: 'post',
    data: {
      ViewAction :  'AJAX-IC_IncludeTemplate',
      IC_Template : 'INC-IC_CheckForRegisteredEmail',
      IC_Hash :     encodeURIComponent(email),
    },
    async: false,
    cache: false,
    context: document.body,
    success: function(data){
      jq('#BasketAddressFormContainer .CheckoutSelect .IC_ExistingUser').html('');
      try
      {
        if (data.length > 0){
          if (jq('<div />').html(data).find('.IC_AlreadyRegisteredInfo').length > 0){
            jq('#BasketAddressFormContainer .CheckoutSelect .IC_ExistingUser').hide().html(data).slideDown('slow');
            jq('div.IC_ExistingUser .IC_LoginInsteadLink').click( function(e) {
              e.preventDefault();
              e.stopPropagation();
              IC_LoginInstead();
              return;
            });
          }
        }
      }
      catch(e)
      {
      }
    }
  });
}

/*================================================================================================
 Description:  This function takes the user to the login section of the basket with prefilled
               e-mail.
==================================================================================================*/
function IC_LoginInstead(){
  try {
    var input = jq('#BasketAddressFormContainer .CheckoutSelect input[name="CustomerType"][value="Member"]');
    if (!input.is(':checked')) {
      jq('#BasketAddressFormContainer .CheckoutSelect .IC_LoginRegistered input[name="Login"]')
        .val(jq('#BasketAddressFormContainer .NonMemberAddressContent #RegisterEMail').val());
      jq(input)
        .prop('checked', true)
        .trigger('change');
      jq('html,body')
        .animate({scrollTop: jq('#BasketAddressFormContainer .CheckoutSelect input[name="CustomerType"][value="Member"]').offset().top -20},'slow');
    }
  }
  catch(err) {
    jq('#BasketAddressFormContainer .CheckoutSelect .IC_ExistingUser')
      .hide()
      .html('There was a technical error, please contact us.')
      .slideDown('slow');
  }
}

/*================================================================================================
 Description:  This function initializes the blur event to check for existing accounts during the
               baskets guest account creation. If the entered e-mail has been cleared by jQuery
               UI's validation, the function IC_FetchEmailRegistered which contains the AJAX is
               called.
==================================================================================================*/
jq(document).ready(function() {
  jq('#BasketAddressFormContainer .NonMemberAddressContent #RegisterEMail, #BasketAddressFormContainer .GetMember #RegisterEMail').bind('blur', function() {
    if(jq(this).val().length > 5 && !jq(this).hasClass('ui-invalid')){
      IC_FetchEmailRegistered(jq(this).val());
    }
  });

  if (jq('#BasketAddressFormContainer .NonMemberAddressContent #RegisterEMail').length > 0 &&
      jq('#BasketAddressFormContainer .NonMemberAddressContent #RegisterEMail').val().length > 0){
     IC_FetchEmailRegistered(jq('#BasketAddressFormContainer .NonMemberAddressContent #RegisterEMail').val());
  }

});


/* End BROE 448 */

/* BROE 456 */
/*================================================================================================
 Description:  Check if Zendesk Chat is active and if so, open the chat window. Otherwise hide link.
==================================================================================================*/
jq(document).ready(function() {
  if(!IC_CheckIfZendeskChatAvailable()){
    jq('.IC_OpenZendeskChat').parents('li').css('display','none');
  }
  else{
    jq('.IC_OpenZendeskChat').click( function() {
      if (status == 'online') {
        $zopim.livechat.window.show();
      }
    });
  }
});

function IC_CheckIfZendeskChatAvailable(){
  if(typeof $zopim !== 'undefined'){
    $zopim(function() {
      $zopim.livechat.setOnStatus(callback);
        function callback(status) {
          if (status == 'online') {
            return 1;
          }
        }
    })
  }
  return 0;
}
/* End BROE 456 */

/* BROE-330 add cookie when search is submitted */
jq(document).ready(function() {
  jq('form[id^=RemoteSearch]').submit(function(){
    createCookie('r', '1', 0.00002);
    return true;
  });
});
/* end BROE-330 */

/* BROE-583 - auto open newsletter popup if it's */
jq(document).ready(function () {
    var h = window.location.hash;
    var p = getURLSearchParam('shownlpopup');
    if((h && h.toLowerCase() == '#shownlpopup') || (p && p > 0)) {
      // BROE-715 - check possible additional parameters
      var delay = getURLSearchParam('delay') ? Number.parseInt(getURLSearchParam('delay')) : 0;
      var hideifsubscribed = getURLSearchParam('hideifsubscribed');

      // if subscribed, dont show the layer
      if(hideifsubscribed == 1 && readCookie("NewsletterSentOn") != null) {
        return;
      }

      var el = jq('.ic-popupLinkNewsletter').first();
      setTimeout(function(){el.trigger('popup-click');}, delay * 1000);
      
    }
});
/* end BROE-583 */


/* BROE-225 - show BUSA ratings in a dialog */
var showBUSARatings = function(title) {
  if(!title){
    title = '&#x2606; brownells.com';
  }
  var w = 620;
  var h = 420;

  if(isMobileMode()) {
    w = 0.8 * document.documentElement.clientWidth;
    h = 0.8 * document.documentElement.clientHeight;
  }

  window['BUSADialog'] = ep('<div class="NoPadding Loading" title="'+title+'"></div>')
                      .uiDialog({
                        modal: true,
                        width: w,
                        height: h,
                        draggable: false
                      });
  var url = epConfig.webUrl + '&ViewAction=AJAX-IC_IncludeTemplate&IC_Template=INC-IC_ViewBUSARatings';
  window['BUSADialog'].dialog('open').load(url, function(){ jq(window['BUSADialog']).removeClass('Loading')});

  if (typeof IC_isPolicyApproved === 'function' && IC_isPolicyApproved('GoogleAnalytics')){
    ga('send', 'event', {eventCategory: 'Interaction', eventAction: 'RatingsShown_BUSALayer'});
  }
}
/* end BROE-225 */

/*================================================================================================
 Description:  Add last viewed products to start page (BROE-538)
==================================================================================================*/
jq(document).ready(function() {
  require([
    "jquery",
    "ep/sslswitch",
    "util/base64",
    'util/storage',
    'jquery/slick'
  ], function($, ep, base64, storage){

    if(jq('.IC_ProductLastViewedBoxSlider').length){
      var stored  = storage.localStorage('Catalog::ProductLastViewed.list') || {};
      var tmplData = [];

      if(jq.isEmptyObject(stored)) {
        jq('h2.IC_ProductLastViewedBoxSliderWrapper .topratedproducts').fadeIn();
      }
      else {
        jq('h2.IC_ProductLastViewedBoxSliderWrapper .lastviewedproducts').fadeIn();

        var tstampMap = [],
          tstampData = [];

        // create am map with tstamps to sort
        $.each( stored, function( id, product ){
          tstampMap.push( product.tstamp );
          tstampData[ product.tstamp ] = product;
        });

        // sort
        tstampMap = tstampMap.sort().reverse();

        // push products in the right order
        $.each( tstampMap, function( i, tstamp ){
          // maximum 10 items
          if( i < 10 ) {
            tmplData.push( tstampData[ tstamp ].id );
          }
        });
      }

      var node    = jq('#ProductLastViewedBox');
      jq.ajax({
        url: ep.config.baseUrl,
        cache: false,
        data :{
          ViewAction :  'AJAX-IC_IncludeTemplate',
          IC_Template : 'INC-IC_RecentlyViewedList',
          StoredProducts : tmplData.join(',')
        }
      })
      .done(function( html ) {
        jq( node ).html( html.replace(/<!--.*-->\n/g, '').trim() );

        if(jq(node).find('.ProductListImageBox').length < 1) {
          jq('.IC_ProductLastViewedBoxSliderWrapper').hide();
          return;
        }

        jq('#ProductLastViewedBox').addClass('IC_Slider');
        jq('#ProductLastViewedBox').each(function() {
          var slides = 5;
            if( isMobileMode() ) {
              slides = jq(this).data('slider-mbl') ? jq(this).data('slider-mbl') : 1;
              jq('#ProductLastViewedBox').attr('slider-mbl', slides);
            }
            else {
              slides = jq(this).data('slider-dsktp') ? jq(this).data('slider-dsktp') : 5;
              jq('#ProductLastViewedBox').attr('slider-dsktp', slides);
            }
  
            jq(this).slick({
              slidesToShow: slides,
              slidesToScroll: slides,
              forceArrows: true,
              dots: false
            });
            
            if( isMobileMode() ) {
              jq('#ProductLastViewedBox.IC_Slider .ProductListImageBox').css('clear', 'none');
            }
        });
      });
    }
  });
});

/*================================================================================================
 Description:  Add scroll to top feature to the ASN form (desktop only) (BROE-652)
 ==================================================================================================*/
jq(document).ready(function(){
  if(isDesktopMode()) {
    jq('#RemoteSearchFacets').on('submit', 'form', function(){
      IC_ScrollToASNTop();
    });
  }
  /* Footer (BROE-534) */
  if(isMobileMode() && jq('.footerBottom .description').find(':visible').length == 0) {
    jq('.footerBottom').addClass("nodescription");
  }
});
/*================================================================================================
 Description:  Scroll to top of ASN (BROE-652)
 ==================================================================================================*/
function IC_ScrollToASNTop() {
  // scroll to top
  target      = jq(".Layout1 > div.Middle").first();
  win_scrtp   = jq(window).scrollTop();
  trg__scrtp  = target.offset().top;
  if(trg__scrtp < win_scrtp) {
    jq('html,body').animate({scrollTop: trg__scrtp});
  }
}

/*================================================================================================
 checkMultiCheckoutChanged
 Description:  fix ui form behaviour to do not refresh in some cases (mostly on quick clicks) (T#ITSD-722)
 ==================================================================================================*/
function checkMultiCheckoutChanged(process, forced) {
  if(window['submitfailcounts'] >2) {
    return;
  }
  
  if(typeof window['submitfailcounts'] === 'undefined') {
    window['submitfailcounts'] = 1;
  }
  else {
    window['submitfailcounts']++;
  }

  var mustbeprocessed  = (typeof forced === 'undefined') ? 0 : forced;
  if(typeof process !== 'object') {
    return;
  }

  if(mustbeprocessed == 0) {
    jq('#BasketForm input[type="radio"]:checked').each(function(idx,el) {
      if( !jq(el).is('[checked="checked"]')) {
        mustbeprocessed = 1;
      }
    });
  }

  if(mustbeprocessed == 1) {
    process.refresh();
  }
}

/*================================================================================================
 Description: Delete a facet entry
 ==================================================================================================*/
function removeFacet(facetAlias) {
  jq('li[data-alias=' + facetAlias + ']').remove();
}

/*================================================================================================
 Description: How to behave on category tab clicks
 ==================================================================================================*/
function toggleCategoryTab(tabName, filterKey, filterValue) {
  var facetList = ['IC_Bestseller', 'IC_BestRated', 'IC_SpecialOffer', 'IsNew'];
  jq.each(facetList, function(idx, val) {
    if( tabName != val ) {
      removeFacet(val);
    }
  });
  
  if( tabName != 'Products' ) {
    if( jq('li[data-alias=' + tabName + '] label').length > 0 ) {
      jq('li[data-alias=' + tabName + '] label[data-name^=FacetValue_]').click();
    }
    else
    {
      var inputField = jq('<input/>');
      inputField.attr('name', filterKey);
      inputField.attr('value', filterValue);
      inputField.attr('type', 'hidden');
      jq('.RemoteSearchFacets form').append( inputField );
      jq('.RemoteSearchFacets form').trigger('submit');
    }
  }
  else
  {
    jq('.RemoteSearchFacets form').trigger('submit');
  }
};

/* BROE-655 - show Consignor DropPoints in a dialog */
var showConsignorDropPoints = function(title, WebShopProductId, DeliveryType) {
  if(!title){
    title = 'Select a DropPoint';
  }
  var w = 620;
  var h = 420;
  w = 0.8 * document.documentElement.clientWidth;
  h = 0.8 * document.documentElement.clientHeight;
  
  var scrollPos = window.scrollY;
  jq('body,html').addClass('freeze');
  jq('body,html').css('top', -scrollPos+'px');

  if(typeof(window['ConsignorDropPointsDialog']) == 'undefined') {
    window['ConsignorDropPointsDialog'] = ep('<div class="NoPadding Loading" title="'+title+'"></div>')
                      .uiDialog({
                        modal: true,
                        width: w,
                        height: h,
                        draggable: false,
                        beforeClose: function() {
                          window.map.remove();
                          jq('body,html').removeClass('freeze');
                          jq('body,html').css('top', 'initial');
                        }
      });
  }
  window['ConsignorDropPointsDialog'].data('DeliveryType', DeliveryType);
  window['ConsignorDropPointsDialog'].data('WebShopProductId', WebShopProductId);
  window['ConsignorDropPointsDialog'].data('title', title);
      
  var url = epConfig.webUrl + '&ViewAction=AJAX-IC_IncludeTemplate&IC_Template=INC-IC_DisplayConsignorDropPoints&WebShopProductId='+WebShopProductId;
  window['ConsignorDropPointsDialog'].dialog('open').load(url, function(){ jq(window['ConsignorDropPointsDialog']).removeClass('Loading')});
}

var getConsignorDropPoints = function(OrderID, WebShopProductId, Zipcode) {

  var ajaxUrl = [location.protocol, '//', location.host, location.pathname].join('');
  if (typeof(ep) != 'undefined'){
    ajaxUrl = ep.config.baseUrl;
  }

  jq(".DropPointSearchError").hide();
  jq.ajax({
    url: ajaxUrl,
    type: 'post',
    data: {
      ViewAction :  'AJAX-IC_IncludeJavaScriptTemplate',
      IC_Template : 'INC-IC_GetConsignorDropPoints',
      WebShopProductId : WebShopProductId,
      Zipcode : Zipcode,
      OrderID : OrderID
    },
    async: false,
    cache: false,
    context: document.body,
    success: function(data){
      try{
        var NewMarkers = JSON.parse(data.replace(/\/\*.+?\*\/|\/\/.*(?=[\n\r])/g, ''));
        IC_AddMarkersToMap(NewMarkers);
      }
      catch (e){
        jq('.DropPointSearchError').show();
      }
    }
  });
};

function IC_AddMarkersToMap(NewMarkers){
  if(typeof NewMarkers !== 'undefined' && NewMarkers.length > 0){
    jq(".DropPointList").empty();
    window.map._panes.marker.remove();
    window.map.createPane('marker');
  
    var MarkerBounds = [];
    for ( var i=0; i < NewMarkers.length; ++i )
    {
      var DropPointInfo = '<div class="DropPoint">';
      DropPointInfo += '<div class="DropPointCounter">'+(i+1)+'</div>';
      DropPointInfo += '<div class="DropPointInfo">';
      DropPointInfo += NewMarkers[i].Name1 + '<br/>' + NewMarkers[i].Address1 + '<br/>' + NewMarkers[i].PostalCode + ' ' + NewMarkers[i].City + '<br/>';
      var MarkerDataJSON = JSON.stringify(NewMarkers[i]);
      var MarkerDataBase64 = encodeURI(MarkerDataJSON);
      DropPointInfo += '<br/><button onclick="javascript:IC_SelectDropPoint(\''+NewMarkers[i].OriginalId+'\', \''+MarkerDataBase64+'\');">'+SelectButtonText+'</button>';
      DropPointInfo += '</div></div>';
      window.L.marker( [NewMarkers[i].MapRefY, NewMarkers[i].MapRefX], {pane: 'marker', icon: new window.L.AwesomeNumberMarkers({number: (i+1), markerColor: 'blue'})} )
      .bindPopup( DropPointInfo )
      .addTo( window.map );
      
      MarkerBounds.push([NewMarkers[i].MapRefY, NewMarkers[i].MapRefX]);
      jq('.DropPointList').append(DropPointInfo);
    }
    
    window.map.fitBounds(MarkerBounds);
  }
  else{
    jq('.DropPointSearchError').show();
  }
}

function IC_SelectDropPoint(DropPointID, DropPointDataObject){
  var DropPointData    = JSON.parse( decodeURI(DropPointDataObject) );
  var DeliveryType     = window['ConsignorDropPointsDialog'].data('DeliveryType');
  var WebShopProductId = window['ConsignorDropPointsDialog'].data('WebShopProductId');
  var DialogTitle      = window['ConsignorDropPointsDialog'].data('title');
  
  if(typeof DropPointID !== 'undefined'){
    jq('.IC_DropPointSelectionFor_'+DeliveryType+' .IC_SelectedDropPointAddress').remove();
    jq('.IC_DropPointsAreaFor_'+DeliveryType+' .IC_DropPointsAvailableInfo').hide();
    
    jq('.IC_DropPointSelectionFor_'+DeliveryType).append('<div class="IC_SelectedDropPointAddress"></div>');
    jq('.IC_DropPointSelectionFor_'+DeliveryType+' .IC_SelectedDropPointAddress').append('<span>'+DropPointData.Name1+'</span>');
    jq('.IC_DropPointSelectionFor_'+DeliveryType+' .IC_SelectedDropPointAddress').append('<a class="ep-sprite Icon SearchIcon IC_SearchDropPoint" href="javascript:showConsignorDropPoints(\''+DialogTitle+'\', '+WebShopProductId+',\''+DeliveryType+'\');">&nbsp;</a>');
    jq('.IC_DropPointSelectionFor_'+DeliveryType+' .IC_SelectedDropPointAddress').append('<a class="ep-sprite Icon TrashIcon IC_DeleteDropPoint" onclick="IC_DeleteDropPoint(\''+DeliveryType+'\')">&nbsp;</a>');
    jq('.IC_DropPointSelectionFor_'+DeliveryType+' .IC_SelectedDropPointAddress').append('<input name="IC_Consignor_DropPointAddress_'+DeliveryType+'" type="hidden" value="'+ DropPointDataObject + '" />');
  }
  window['ConsignorDropPointsDialog'].dialog('close');
  
  require(["jquery", "de_epages/order/inc/multicheckoutprocess", "$ready!"], function ($, multiCheckOutProcess) {
    var process = multiCheckOutProcess('#'+'BasketForm');
    process.refresh();
    checkMultiCheckoutChanged(process);
  });
}

function IC_DeleteDropPoint(DeliveryType){
  jq('.IC_Consignor_DropPointAddress_'+DeliveryType).remove();
  jq('.IC_DropPointsAreaFor_'+DeliveryType+' .IC_DropPointsAvailableInfo').show();
  jq('.IC_DropPointSelectionFor_'+DeliveryType+' .IC_SelectedDropPointAddress').remove();
  require(["jquery", "de_epages/order/inc/multicheckoutprocess", "$ready!"], function ($, multiCheckOutProcess) {
    var process = multiCheckOutProcess('#'+'BasketForm');
    process.refresh();
    checkMultiCheckoutChanged(process);
  });
}

/* end BROE-655 */


// BROE-715 - return the value of the given url parameter 
function getURLSearchParam(paraname) {
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
    if(pair[0] == paraname){
      return pair[1];
    }
  }
  return(false);
}

/* BROE-769 */
jq(document).ready(function(){
  jq('.RelocateBestsellerBoxes .IC_ProductBestRatedBoxSliderWrapper, .RelocateBestsellerBoxes .IC_ProductBestRatedBoxSlider, .RelocateBestsellerBoxes .IC_ProductBestsellerBoxSliderWrapper, .RelocateBestsellerBoxes .IC_ProductBestsellerBoxSlider').insertAfter('.IC_PopularBox').css('display','inherit');
});
/* END BROE-769 */

/* BROE-XXX Prevent double submission of forms to prevent doubled lineitems */
jq(document).ready(function(){ 
  jq('body').on('submit', 'form', '', function(e){

    // Do not check if already skipped
    if(e.isDefaultPrevented()) {
      return;
    }

    var $form = jq(this);
    if ($form.data('isSubmitted') === true) {
      e.preventDefault();
    } else {
      $form.data('isSubmitted', true);
    }
  });
});
/* END BROE-XXX */